name: Build Shaka (custom)

# uruchamiaj ręcznie lub przy push na main — dopasuj do potrzeb
on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-shaka:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # zmień nazwę wyjściowego pliku jeśli chcesz
      OUT_DIR: dist
      OUT_NAME: shaka-player.dash.custom.js

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'   # lub inna wersja node której potrzebujesz

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install npm deps (if package.json present)
        if: filesExists('package.json')
        run: |
          npm ci

      - name: Set up Java (JDK) for Closure Compiler
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'   # Adoptium/Temurin
          java-version: '17'        # Shaka closure needs Java; 11/17 ok

      - name: Show versions
        run: |
          node -v
          npm -v
          python3 --version
          java -version

      - name: Ensure output dir
        run: mkdir -p $OUT_DIR

      - name: Run Shaka custom build (DASH, no UI, no offline, no ads)
        # run as bash command; on ubuntu 'python3' exists
        run: |
          set -e
          # przykład buildu oparty o build_args_only_dash_without_ui z all.py
          python3 build/build.py --name dash \
            +@complete -@ui -@polyfillForUI \
            -@mss -@offline -@cast -@ads \
            --mode release
          # Shaka build.py zapisuje pliki do dist/..., ale dla pewności
          # skopiujemy/połączymy do prostego pliku w $OUT_DIR
          # (dostosuj ścieżkę, jeśli build.py zapisuje do innej lokalizacji)
          # Znajdź najnowszy plik shaka-player*.js w dist/
          out=$(ls -1t dist/*shaka-player*js 2>/dev/null | head -n1 || true)
          if [ -z "$out" ]; then
            echo "ERROR: built file not found in dist/"; ls -la dist || true
            exit 2
          fi
          echo "Built file: $out"
          cp "$out" "$OUT_DIR/$OUT_NAME"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: shaka-player-build
          path: ${{ env.OUT_DIR }}/

      # opcjonalne: utwórz GitHub Release i dołącz artefakt (odkomentuj jeśli chcesz)
      # - name: Create Release
      #   id: create_release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: build-${{ github.run_number }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #
      # - name: Upload release asset
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     files: ${{ env.OUT_DIR }}/$OUT_NAME
