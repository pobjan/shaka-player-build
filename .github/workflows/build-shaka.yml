name: Build Shaka Player (custom)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      OUT_DIR: dist
      OUT_FILE: shaka-player.custom.js

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java (for Closure Compiler)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Show tool versions
        run: |
          node -v
          npm -v
          python3 --version
          java -version

      - name: Install npm dependencies (if needed)
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Create dist directory
        run: mkdir -p $OUT_DIR

      - name: Build Shaka Player (custom flags)
        run: |
          set -e

          python3 build/build.py \
            --name custom \
            +@complete \
            -@ui \
            -@polyfillForUI \
            -@mss \
            -@offline \
            -@cast \
            -@ads \
            --mode release

          # znajdź wygenerowany plik i skopiuj do ustalonej nazwy
          BUILT_FILE=$(ls -1t dist/*shaka-player*.js | head -n 1)

          if [ -z "$BUILT_FILE" ]; then
            echo "❌ Build failed: no output JS file found"
            exit 1
          fi

          cp "$BUILT_FILE" "$OUT_DIR/$OUT_FILE"
          echo "✅ Output: $OUT_DIR/$OUT_FILE"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shaka-player-custom-build
          path: dist/
